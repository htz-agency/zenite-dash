cubes:
  - name: activities
    sql_table: public.crm_activities

    joins:
      - name: leads
        sql: "{CUBE}.entity_id = {leads}.id AND {CUBE}.entity_type = 'lead'"
        relationship: many_to_one

      - name: opportunities
        sql: "{CUBE}.entity_id = {opportunities}.id AND {CUBE}.entity_type = 'opportunity'"
        relationship: many_to_one

      - name: contacts
        sql: "{CUBE}.contact_id = {contacts}.id"
        relationship: many_to_one

    measures:
      - name: count
        type: count

      - name: completed_count
        type: count
        filters:
          - sql: "{CUBE}.completed_at IS NOT NULL"

      - name: pending_count
        type: count
        filters:
          - sql: "{CUBE}.completed_at IS NULL AND ({CUBE}.status IS NULL OR LOWER({CUBE}.status) NOT IN ('concluida', 'completed', 'done', 'cancelada', 'cancelled'))"

      - name: overdue_count
        type: count
        filters:
          - sql: "{CUBE}.completed_at IS NULL AND {CUBE}.due_date < NOW()"

      - name: completion_rate
        type: number
        sql: "CASE WHEN {count} > 0 THEN ROUND(({completed_count}::numeric / {count}::numeric) * 100, 2) ELSE 0 END"

      - name: avg_completion_hours
        type: avg
        sql: "EXTRACT(EPOCH FROM ({CUBE}.completed_at - {CUBE}.created_at)) / 3600.0"
        filters:
          - sql: "{CUBE}.completed_at IS NOT NULL"

      - name: total_call_duration
        type: sum
        sql: call_duration

      - name: avg_call_duration
        type: avg
        sql: call_duration

    dimensions:
      - name: id
        sql: id
        type: string
        primary_key: true

      - name: type
        sql: type
        type: string

      - name: label
        sql: label
        type: string

      - name: subject
        sql: subject
        type: string

      - name: description
        sql: description
        type: string

      - name: status
        sql: status
        type: string

      - name: priority
        sql: priority
        type: string

      - name: owner
        sql: owner
        type: string

      - name: assigned_to
        sql: assigned_to
        type: string

      - name: entity_type
        sql: entity_type
        type: string

      - name: entity_id
        sql: entity_id
        type: string

      - name: related_to_type
        sql: related_to_type
        type: string

      - name: related_to_name
        sql: related_to_name
        type: string

      - name: contact_name
        sql: contact_name
        type: string

      - name: contact_id
        sql: contact_id
        type: string

      - name: location
        sql: location
        type: string

      - name: all_day
        sql: all_day
        type: boolean

      - name: is_private
        sql: is_private
        type: boolean

      - name: is_recurring
        sql: is_recurring
        type: boolean

      - name: tags
        sql: tags
        type: string

      - name: channel
        sql: channel
        type: string

      - name: call_type
        sql: call_type
        type: string

      - name: call_direction
        sql: call_direction
        type: string

      - name: call_result
        sql: call_result
        type: string

      - name: busy_status
        sql: busy_status
        type: string

      - name: calendar_name
        sql: calendar_name
        type: string

      - name: created_by
        sql: created_by
        type: string

      - name: created_at
        sql: created_at
        type: time

      - name: updated_at
        sql: updated_at
        type: time

      - name: due_date
        sql: due_date
        type: time

      - name: start_date
        sql: start_date
        type: time

      - name: end_date
        sql: end_date
        type: time

      - name: completed_at
        sql: completed_at
        type: time

      # Computed dimensions
      - name: type_group
        type: string
        case:
          when:
            - sql: "LOWER({CUBE}.type::text) SIMILAR TO '%(tarefa|task)%'"
              label: Tarefa
            - sql: "LOWER({CUBE}.type::text) SIMILAR TO '%(compromisso|evento|event|reuniao|meeting|calendar)%'"
              label: Compromisso
            - sql: "LOWER({CUBE}.type::text) SIMILAR TO '%(ligacao|call|telefone)%'"
              label: Ligacao
            - sql: "LOWER({CUBE}.type::text) SIMILAR TO '%(email|e-mail)%'"
              label: Email
            - sql: "LOWER({CUBE}.type::text) SIMILAR TO '%(nota|note|anotacao)%'"
              label: Nota
            - sql: "LOWER({CUBE}.type::text) SIMILAR TO '%(mensagem|message|whatsapp|sms|chat)%'"
              label: Mensagem
          else:
            label: Outro

      - name: status_group
        type: string
        case:
          when:
            - sql: "{CUBE}.completed_at IS NOT NULL"
              label: Concluida
            - sql: "{CUBE}.due_date < NOW() AND {CUBE}.completed_at IS NULL"
              label: Atrasada
          else:
            label: Pendente

    pre_aggregations:
      - name: activities_by_day
        measures:
          - count
          - completed_count
          - overdue_count
        dimensions:
          - type_group
          - status_group
          - owner
        time_dimension: created_at
        granularity: day
