cubes:
  - name: leads
    sql_table: public.crm_leads

    joins:
      - name: accounts
        sql: "{CUBE}.company = {accounts}.name"
        relationship: many_to_one

      - name: activities
        sql: "{CUBE}.id = {activities}.entity_id AND {activities}.entity_type = 'lead'"
        relationship: one_to_many

    measures:
      - name: count
        type: count

      - name: active_count
        type: count
        filters:
          - sql: "{CUBE}.is_active = true AND {CUBE}.is_deleted = false"

      - name: total_revenue
        type: sum
        sql: annual_revenue

      - name: avg_revenue
        type: avg
        sql: annual_revenue

      - name: avg_score
        type: avg
        sql: score

      - name: avg_qualification
        type: avg
        sql: qualification_progress

      - name: total_employees
        type: sum
        sql: employee_count

      - name: avg_conversion_rate
        type: avg
        sql: conversion_rate

      - name: converted_count
        type: count
        filters:
          - sql: "{CUBE}.stage IN ('Convertido', 'Qualificado')"

      - name: conversion_rate
        type: number
        sql: "CASE WHEN {count} > 0 THEN ROUND(({converted_count}::numeric / {count}::numeric) * 100, 2) ELSE 0 END"

    dimensions:
      - name: id
        sql: id
        type: string
        primary_key: true

      - name: name
        sql: "COALESCE({CUBE}.name, '') || ' ' || COALESCE({CUBE}.lastname, '')"
        type: string

      - name: first_name
        sql: name
        type: string

      - name: last_name
        sql: lastname
        type: string

      - name: role
        sql: role
        type: string

      - name: company
        sql: company
        type: string

      - name: phone
        sql: phone
        type: string

      - name: email
        sql: email
        type: string

      - name: address
        sql: address
        type: string

      - name: type
        sql: type
        type: string

      - name: origin
        sql: origin
        type: string

      - name: segment
        sql: segment
        type: string

      - name: stage
        sql: stage
        type: string

      - name: stage_complement
        sql: stage_complement
        type: string

      - name: owner
        sql: owner
        type: string

      - name: score
        sql: score
        type: number

      - name: score_label
        sql: score_label
        type: string

      - name: qualification_progress
        sql: qualification_progress
        type: number

      - name: annual_revenue
        sql: annual_revenue
        type: number

      - name: employee_count
        sql: employee_count
        type: number

      - name: conversion_rate_raw
        sql: conversion_rate
        type: number

      - name: is_active
        sql: is_active
        type: boolean

      - name: is_deleted
        sql: is_deleted
        type: boolean

      - name: website
        sql: website
        type: string

      - name: preferred_contact
        sql: preferred_contact
        type: string

      - name: response_time
        sql: response_time
        type: string

      - name: tags
        sql: tags
        type: string

      - name: mkt_campanha
        sql: mkt_campanha
        type: string

      - name: mkt_grupo_anuncios
        sql: mkt_grupo_anuncios
        type: string

      - name: mkt_anuncio
        sql: mkt_anuncio
        type: string

      - name: mkt_canal
        sql: mkt_canal
        type: string

      - name: created_by
        sql: created_by
        type: string

      - name: created_at
        sql: created_at
        type: time

      - name: updated_at
        sql: updated_at
        type: time

      - name: last_activity_date
        sql: last_activity_date
        type: time

      - name: mkt_ultima_conversao
        sql: mkt_ultima_conversao
        type: time

    pre_aggregations:
      - name: leads_by_month
        measures:
          - count
          - total_revenue
          - avg_score
        dimensions:
          - stage
          - owner
          - origin
        time_dimension: created_at
        granularity: month
