cubes:
  - name: accounts
    sql_table: public.crm_accounts
    sql: "SELECT * FROM public.crm_accounts WHERE is_deleted = false"

    joins:
      - name: contacts
        sql: "{CUBE}.name = {contacts}.account"
        relationship: one_to_many

      - name: opportunities
        sql: "{CUBE}.name = {opportunities}.account"
        relationship: one_to_many

    measures:
      - name: count
        type: count

      - name: total_revenue
        type: sum
        sql: annual_revenue

      - name: avg_revenue
        type: avg
        sql: annual_revenue

      - name: total_employees
        type: sum
        sql: employees

      - name: avg_employees
        type: avg
        sql: employees

      - name: total_contacts
        type: sum
        sql: contacts

      - name: with_partner_count
        type: count
        filters:
          - sql: "{CUBE}.partner_account = true"

    dimensions:
      - name: id
        sql: id
        type: string
        primary_key: true

      - name: name
        sql: name
        type: string

      - name: type
        sql: type
        type: string

      - name: stage
        sql: stage
        type: string

      - name: owner
        sql: owner
        type: string

      - name: sector
        sql: sector
        type: string

      - name: website
        sql: website
        type: string

      - name: phone
        sql: phone
        type: string

      - name: email
        sql: email
        type: string

      - name: cnpj
        sql: cnpj
        type: string

      - name: annual_revenue
        sql: annual_revenue
        type: number

      - name: employees
        sql: employees
        type: number

      - name: rating
        sql: rating
        type: string

      - name: origin
        sql: origin
        type: string

      - name: ownership
        sql: ownership
        type: string

      - name: partner_account
        sql: partner_account
        type: boolean

      - name: segment
        sql: segment
        type: string

      - name: do_not_contact
        sql: do_not_contact
        type: boolean

      - name: tags
        sql: tags
        type: string

      - name: mkt_campanha
        sql: mkt_campanha
        type: string

      - name: mkt_canal
        sql: mkt_canal
        type: string

      - name: is_deleted
        sql: is_deleted
        type: boolean

      - name: billing_city
        sql: billing_city
        type: string

      - name: billing_state
        sql: billing_state
        type: string

      - name: billing_country
        sql: billing_country
        type: string

      - name: shipping_city
        sql: shipping_city
        type: string

      - name: shipping_state
        sql: shipping_state
        type: string

      - name: created_by
        sql: created_by
        type: string

      - name: created_at
        sql: created_at
        type: time

      - name: updated_at
        sql: updated_at
        type: time

      - name: last_activity_date
        sql: last_activity_date
        type: time

      - name: revenue_range
        type: string
        case:
          when:
            - sql: "{CUBE}.annual_revenue IS NULL OR {CUBE}.annual_revenue = 0"
              label: Sem receita
            - sql: "{CUBE}.annual_revenue < 100000"
              label: "< R$100k"
            - sql: "{CUBE}.annual_revenue < 500000"
              label: "R$100k - R$500k"
            - sql: "{CUBE}.annual_revenue < 1000000"
              label: "R$500k - R$1M"
          else:
            label: "> R$1M"

      - name: size
        type: string
        case:
          when:
            - sql: "{CUBE}.employees IS NULL OR {CUBE}.employees = 0"
              label: Desconhecido
            - sql: "{CUBE}.employees <= 10"
              label: Micro
            - sql: "{CUBE}.employees <= 50"
              label: Pequena
            - sql: "{CUBE}.employees <= 250"
              label: Media
          else:
            label: Grande

    pre_aggregations:
      - name: accounts_by_month
        measures:
          - count
          - total_revenue
          - avg_revenue
        dimensions:
          - sector
          - stage
          - owner
          - billing_state
        time_dimension: created_at
        granularity: month
